<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Fundora TON Connect</title>
    <script src="https://cdn.jsdelivr.net/npm/@tonconnect/ui@2.0.12/dist/tonconnect-ui.min.js"></script>
</head>
<body style="font-family:sans-serif; padding: 16px;">
<h3 id="status">Waiting for nonce…</h3>

<script>
    const status = document.getElementById("status");

    function log(msg) {
        console.log(msg);
        status.innerText = msg;
    }

    let tonUI = null;
    let walletConnected = false;

    // Disconnect function
    window.disconnectWallet = function() {
        if (tonUI && walletConnected) {
            tonUI.disconnect();
            walletConnected = false;
            log("Wallet disconnected");
        }
    }

    // React to Android-injected nonce
    Object.defineProperty(window, 'FUNDORA_NONCE', {
        set: function(value) {
            this._nonce = value;
            if (value && value !== "") {
                log("Nonce received, connecting…");
                startConnection(value);
            }
        },
        get: function() {
            return this._nonce;
        }
    });

    function startConnection(nonce) {
        if (tonUI) return; // Already initialized

        tonUI = new TON_CONNECT_UI.TonConnectUI({
            //manifestUrl: "https://kyawsanoo.github.io/fundora/tonconnect-manifest.json",
            manifestUrl: "https://zyczqnpuwpxidaktpfzm.supabase.co/storage/v1/object/public/tonconnect/tonconnect-manifest.json",
            actionsConfiguration: {
                returnUrl: "https://kyawsanoo.github.io/fundora/toncallback.html"
            }
        });

        tonUI.connectWallet({
            tonProof: {
                payload: nonce
            }
        });


        tonUI.onStatusChange(wallet => {
            if (!wallet) return;

            const address = wallet.account.address;
            const proof = wallet.connectItems?.tonProof?.proof || "";

            walletConnected = true;
            log("Wallet connected: " + address);

            // If in WebView, notify Android
            if (window.Android && window.Android.onWalletConnected) {
                window.Android.onWalletConnected(address, proof);
                if (window.Android.closeTonConnectDialog) {
                    window.Android.closeTonConnectDialog();
                }
            }

            // For browser: store and redirect
            else {
                localStorage.setItem("walletAddress", address);
                localStorage.setItem("walletProof", proof);
                // Optionally redirect to main page
                window.location.href = "/index.html";
            }


        });
    }

    log("Waiting for nonce…");
</script>
</body>
</html>
